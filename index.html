<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>癒し待夢 コースタイマー</title>
<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Noto Sans JP",sans-serif;
  background:#ffffff;
  margin:0;
  padding:16px;
}
.container{max-width:420px;margin:0 auto;}
h1{text-align:center;font-size:20px;margin-bottom:12px;}
.buttons{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px;}
button{padding:12px;border-radius:10px;border:1px solid #ccc;background:#f7f7f7;font-size:16px;}
button.main{background:#ffd6e5;border-color:#f0a0c0;font-weight:700;}
.display{font-size:40px;text-align:center;margin:14px 0;}
.status{text-align:center;color:#666;margin-bottom:10px;}
.extend{display:flex;gap:8px;justify-content:center;margin-bottom:12px;}
.extend button{flex:1;background:#e9f5ff;border-color:#9cc9ff;}
.controls{display:flex;gap:8px;}
.controls button{flex:1;background:#eee;}
</style>
</head>
<body>
<div class="container">
<h1>癒し待夢 現場用コースタイマー</h1>

<div class="buttons">
<button class="main" onclick="setTimer(90)">90分</button>
<button class="main" onclick="setTimer(120)">120分</button>
<button class="main" onclick="setTimer(150)">150分</button>
<button class="main" onclick="setTimer(180)">180分</button>
<button class="main" onclick="setTimer(240)">30分</button>
<button class="main" onclick="setTimer(300)">60分</button>
</div>

<div class="display" id="timeDisplay">00:00</div>
<div class="status" id="status">未設定</div>

<div class="extend">
<button onclick="extendTime(30)">+30分 延長</button>
<button onclick="extendTime(60)">+60分 延長</button>
</div>

<div class="controls">
<button onclick="pauseTimer()">一時停止</button>
<button onclick="resumeTimer()">再開</button>
<button onclick="resetTimer()">リセット</button>
</div>

<div class="controls" style="margin-top:8px;">
<button onclick="stopEndAlert()">終了アラート停止</button>
</div>

<!-- 音源 -->
<audio id="tenMinSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>
<audio id="endSound">
  <source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg">
</audio>
</div>

<script>
let totalSeconds = 0;
let remainingSeconds = 0;
let timerInterval = null;
let tenMinAlertFired = false;
let endAlertInterval = null;
let wakeLock = null;

// Wake Lock（画面スリープ防止）
async function requestWakeLock() {
  try {
    wakeLock = await navigator.wakeLock.request('screen');
  } catch (err) {
    console.log('Wake Lock 取得失敗', err);
  }
}

document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible') {
    requestWakeLock();
  }
});

function setTimer(minutes){
  stopEndAlert();
  document.body.style.backgroundColor = '#ffffff';
  document.getElementById('timeDisplay').style.color = '#000';
  document.getElementById('timeDisplay').style.fontSize = '40px';

  totalSeconds = minutes * 60;
  remainingSeconds = totalSeconds;
  tenMinAlertFired = false;

  startTimer();
  document.getElementById('status').textContent = minutes + '分コース開始';

  requestWakeLock();
}

function startTimer(){
  clearInterval(timerInterval);
  updateDisplay();
  timerInterval = setInterval(tick, 1000);
}

function tick(){
  if(remainingSeconds <= 0){
    clearInterval(timerInterval);
    document.getElementById('status').textContent = '終了しました';
    startEndAlert();
    return;
  }

  remainingSeconds--;

  // 残り15分で色を変える
  if(remainingSeconds === 900){
    document.body.style.backgroundColor = '#fff8cc'; // 薄い黄色
  }

  // 残り10分アラート
  if(remainingSeconds === 600 && !tenMinAlertFired){
    tenMinAlertFired = true;
    document.getElementById('status').textContent = '残り10分';
    playTenMinSound();
    document.body.style.backgroundColor = '#ffe6b3'; // オレンジ
  }

  updateDisplay();
}

function extendTime(minutes){
  remainingSeconds += minutes * 60;
  totalSeconds += minutes * 60;
  tenMinAlertFired = false;
  document.getElementById('status').textContent = minutes + '分延長';
}

function pauseTimer(){
  clearInterval(timerInterval);
  document.getElementById('status').textContent = '一時停止中';
}

function resumeTimer(){
  clearInterval(timerInterval);
  timerInterval = setInterval(tick, 1000);
  document.getElementById('status').textContent = '再開中';
}

function resetTimer(){
  clearInterval(timerInterval);
  stopEndAlert();
  totalSeconds = 0;
  remainingSeconds = 0;
  tenMinAlertFired = false;
  updateDisplay();
  document.getElementById('status').textContent = 'リセット';
  document.body.style.backgroundColor = '#ffffff';
}

function updateDisplay(){
  const min = Math.floor(remainingSeconds / 60);
  const sec = remainingSeconds % 60;
  document.getElementById('timeDisplay').textContent =
    String(min).padStart(2,'0') + ':' + String(sec).padStart(2,'0');
}

// 10分前の音（控えめ・1回）
function playTenMinSound(){
  const audio = document.getElementById('tenMinSound');
  audio.volume = 0.4;
  audio.currentTime = 0;
  audio.play();
}

// 終了アラート開始（繰り返し）
function startEndAlert(){
  showEndAlert();

  if(endAlertInterval) return;

  playEndBeep3();

  endAlertInterval = setInterval(() => {
    playEndBeep3();
  }, 10000); // 10秒おきに繰り返し
}

// 終了音：控えめに3回
function playEndBeep3(){
  const audio = document.getElementById('endSound');
  audio.volume = 0.3;

  let count = 0;
  const interval = setInterval(() => {
    audio.currentTime = 0;
    audio.play();
    count++;

    if(count >= 3){
      clearInterval(interval);
    }
  }, 700);
}

// 終了時の画面表示
function showEndAlert(){
  document.body.style.backgroundColor = '#ffe5e5';
  const t = document.getElementById('timeDisplay');
  t.style.color = '#c00000';
  t.style.fontSize = '52px';
}

// 終了アラート停止
function stopEndAlert(){
  if(endAlertInterval){
    clearInterval(endAlertInterval);
    endAlertInterval = null;
  }
}
</script>
</body>
</html>
